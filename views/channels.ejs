<body>
  <header>
    <h1>Gestión de Canales</h1>
    <a href="/">Volver al inicio</a>
  </header>
  <main>
    <!-- Formulario para ingresar el código único -->
    <section id="access-code-section">
      <h2>Acceso Restringido</h2>
      <form id="access-code-form">
        <label>
          Ingresa el código de acceso:
          <input type="password" id="access-code" placeholder="Código único" required>
        </label>
        <button type="submit">Validar</button>
      </form>
    </section>

    <!-- Lista de canales -->
    <section id="channels-list-section" style="display: none;">
      <h2>Lista de Canales</h2>
      <ul>
        <% channels.forEach((channel, index) => { %>
          <li>
            <div>
              <strong><%= channel.name %></strong>
            </div>
            <div>
              Última actualización:
              <%= channel.lastUpdated %>
            </div>
            <div class="countdown" id="countdown-<%= index %>"></div>

            <form action="/channels/edit" method="POST">
              <input type="hidden" name="index" value="<%= index %>">
              <label>
                Nombre:
                <input type="text" name="name" value="<%= channel.name %>" required>
              </label>
              <label>
                HLS URL:
                <input type="text" name="hlsUrl" value="<%= channel.hlsUrl %>" required>
              </label>
              <label>
                RTMP URL:
                <input type="text" name="rtmpUrl" value="<%= channel.rtmpUrl %>" required>
              </label>
              <button type="submit">Guardar</button>
            </form>
            <form action="/channels/start" method="POST" style="display: inline;">
              <input type="hidden" name="name" value="<%= channel.name %>">
              <button type="submit">Iniciar</button>
            </form>
            <form action="/channels/stop" method="POST" style="display: inline;">
              <input type="hidden" name="name" value="<%= channel.name %>">
              <button type="submit">Detener</button>
            </form>
            <form action="/channels/delete" method="POST" style="display: inline;">
              <input type="hidden" name="name" value="<%= channel.name %>">
              <button type="submit" class="delete">Eliminar</button>
            </form>
          </li>
        <% }); %>
      </ul>
    </section>
  </main>

  <script>
    // Código único configurado en el servidor o archivo de configuración
    const CONFIGURED_ACCESS_CODE = "he)50_8VjgGiu7DG";

    // Validar el código único
    const accessCodeForm = document.getElementById("access-code-form");
    const accessCodeInput = document.getElementById("access-code");
    const channelsListSection = document.getElementById("channels-list-section");
    const accessCodeSection = document.getElementById("access-code-section");

    accessCodeForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const enteredCode = accessCodeInput.value;

      if (enteredCode === CONFIGURED_ACCESS_CODE) {
        accessCodeSection.style.display = "none";
        channelsListSection.style.display = "block";
      } else {
        alert("Código incorrecto. Intenta de nuevo.");
      }
    });

    // Función para calcular la cuenta regresiva
    function updateCountdown(lastUpdatedTime, elementId) {
      const countdownElement = document.getElementById(elementId);
      const now = new Date();
      const lastUpdated = new Date(lastUpdatedTime);
      const hoursDifference = (now - lastUpdated) / 1000 / 60 / 60;

      if (hoursDifference < 4) {
        const countdownTime = 4 - hoursDifference;
        const countdownText = `${Math.floor(countdownTime)} horas restantes`;
        countdownElement.textContent = countdownText;
      } else {
        countdownElement.textContent = "Tiempo agotado";
      }
    }

    // Calcular la cuenta regresiva para cada canal
    <% channels.forEach((channel, index) => { %>
      const lastUpdatedTime = "<%= channel.lastUpdated %>";
      updateCountdown(lastUpdatedTime, "countdown-<%= index %>");
    <% }); %>
  </script>
</body>
